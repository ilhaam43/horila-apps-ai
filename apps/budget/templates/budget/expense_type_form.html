{% extends "budget/base_budget.html" %}
{% load static %}
{% load i18n %}
{% load budget_filters %}
{% load widget_tweaks %}

{% block title %}
{% if form.instance.pk %}
    {% trans "Edit Expense Type" %}
{% else %}
    {% trans "Add Expense Type" %}
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.form-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}
.color-picker {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    margin: 0.25rem;
}
.color-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}
.expense-type-preview {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        {% if form.instance.pk %}
                            {% trans "Edit Expense Type" %}
                        {% else %}
                            {% trans "Add Expense Type" %}
                        {% endif %}
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'budget:dashboard' %}">{% trans "Budget" %}</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'budget:expense_type_list' %}">{% trans "Expense Types" %}</a></li>
                            <li class="breadcrumb-item active">
                                {% if form.instance.pk %}
                                    {% trans "Edit" %}
                                {% else %}
                                    {% trans "Add" %}
                                {% endif %}
                            </li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{% url 'budget:expense_type_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> {% trans "Back to List" %}
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Form Column -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-receipt"></i>
                                {% if form.instance.pk %}
                                    {% trans "Edit Expense Type" %}
                                {% else %}
                                    {% trans "Expense Type Information" %}
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="expenseTypeForm" novalidate>
                                {% csrf_token %}
                                
                                <!-- Basic Information -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.name.id_for_label }}" class="form-label">
                                            {{ form.name.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.name|add_class:"form-control" }}
                                        {% if form.name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.name.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{% trans "Enter a descriptive name for this expense type" %}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.code.id_for_label }}" class="form-label">
                                            {{ form.code.label }}
                                        </label>
                                        {{ form.code|add_class:"form-control" }}
                                        {% if form.code.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.code.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{% trans "Optional short code for quick identification" %}</div>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">
                                        {{ form.description.label }}
                                    </label>
                                    {{ form.description|add_class:"form-control" }}
                                    {% if form.description.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.description.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Provide a detailed description of this expense type" %}</div>
                                </div>

                                <!-- Color Selection -->
                                <div class="mb-3">
                                    <label for="{{ form.color.id_for_label }}" class="form-label">
                                        {{ form.color.label }}
                                    </label>
                                    <div class="d-flex align-items-center">
                                        {{ form.color|add_class:"form-control me-3" }}
                                        <div class="color-preview" id="colorPreview" 
                                             style="width: 40px; height: 40px; border: 1px solid #ccc; border-radius: 50%; background-color: #007bff;"></div>
                                    </div>
                                    {% if form.color.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.color.errors.0 }}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Color Suggestions -->
                                    <div class="color-suggestions mt-2">
                                        <small class="text-muted d-block mb-2">{% trans "Quick color suggestions:" %}</small>
                                        <div class="d-flex flex-wrap">
                                            <button type="button" class="color-picker" style="background-color: #007bff;" data-color="#007bff" title="Blue"></button>
                                            <button type="button" class="color-picker" style="background-color: #28a745;" data-color="#28a745" title="Green"></button>
                                            <button type="button" class="color-picker" style="background-color: #dc3545;" data-color="#dc3545" title="Red"></button>
                                            <button type="button" class="color-picker" style="background-color: #ffc107;" data-color="#ffc107" title="Yellow"></button>
                                            <button type="button" class="color-picker" style="background-color: #17a2b8;" data-color="#17a2b8" title="Cyan"></button>
                                            <button type="button" class="color-picker" style="background-color: #6f42c1;" data-color="#6f42c1" title="Purple"></button>
                                            <button type="button" class="color-picker" style="background-color: #fd7e14;" data-color="#fd7e14" title="Orange"></button>
                                            <button type="button" class="color-picker" style="background-color: #e83e8c;" data-color="#e83e8c" title="Pink"></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.is_active|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                                {{ form.is_active.label }}
                                            </label>
                                            {% if form.is_active.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.is_active.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">{% trans "Active expense types can be used for new expenses" %}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.requires_approval|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ form.requires_approval.id_for_label }}">
                                                {{ form.requires_approval.label }}
                                            </label>
                                            {% if form.requires_approval.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.requires_approval.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">{% trans "Expenses of this type will require approval" %}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Budget Limits -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.default_budget_limit.id_for_label }}" class="form-label">
                                            {{ form.default_budget_limit.label }}
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.default_budget_limit|add_class:"form-control" }}
                                        </div>
                                        {% if form.default_budget_limit.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.default_budget_limit.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{% trans "Default budget limit for this expense type" %}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.max_amount_per_expense.id_for_label }}" class="form-label">
                                            {{ form.max_amount_per_expense.label }}
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.max_amount_per_expense|add_class:"form-control" }}
                                        </div>
                                        {% if form.max_amount_per_expense.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.max_amount_per_expense.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{% trans "Maximum amount allowed per single expense" %}</div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-flex justify-content-between">
                                    <div>
                                        {% if form.instance.pk %}
                                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                            <i class="fas fa-trash"></i> {% trans "Delete" %}
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <a href="{% url 'budget:expense_type_list' %}" class="btn btn-outline-secondary me-2">
                                            {% trans "Cancel" %}
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            {% if form.instance.pk %}
                                                {% trans "Update Expense Type" %}
                                            {% else %}
                                                {% trans "Create Expense Type" %}
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Preview Column -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-eye"></i> {% trans "Preview" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="expense-type-preview" id="expenseTypePreview">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-3">
                                        <div class="rounded-circle" id="previewColor" 
                                             style="width: 40px; height: 40px; background-color: #007bff;"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" id="previewName">{{ form.name.value|default:'Expense Type Name' }}</h6>
                                        <small class="text-muted" id="previewCode">{{ form.code.value|default:'CODE' }}</small>
                                    </div>
                                </div>
                                
                                <p class="text-muted mb-3" id="previewDescription">
                                    {{ form.description.value|default:'Expense type description will appear here...' }}
                                </p>
                                
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <div class="h6 mb-0 text-primary" id="previewBudgetLimit">
                                                {{ form.default_budget_limit.value|default:'0'|currency_format }}
                                            </div>
                                            <small class="text-muted">{% trans "Budget Limit" %}</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="h6 mb-0 text-success" id="previewMaxAmount">
                                            {{ form.max_amount_per_expense.value|default:'0'|currency_format }}
                                        </div>
                                        <small class="text-muted">{% trans "Max Amount" %}</small>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <span class="badge" id="previewStatus">
                                        {% if form.is_active.value %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                                    </span>
                                    <span class="badge bg-warning ms-1" id="previewApproval" 
                                          {% if not form.requires_approval.value %}style="display: none;"{% endif %}>
                                        <i class="fas fa-check-circle"></i> {% trans "Requires Approval" %}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Usage Tips -->
                            <div class="mt-4">
                                <h6>{% trans "Tips" %}</h6>
                                <ul class="list-unstyled small text-muted">
                                    <li><i class="fas fa-lightbulb text-warning"></i> {% trans "Choose descriptive names for easy identification" %}</li>
                                    <li><i class="fas fa-palette text-info"></i> {% trans "Use different colors to visually distinguish expense types" %}</li>
                                    <li><i class="fas fa-shield-alt text-success"></i> {% trans "Enable approval for sensitive expense types" %}</li>
                                    <li><i class="fas fa-calculator text-primary"></i> {% trans "Set budget limits to control spending" %}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if form.instance.pk %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Delete Expense Type" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Are you sure you want to delete this expense type?" %}</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    {% trans "This action cannot be undone. All associated expenses will lose their type classification." %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <a href="{% url 'budget:expense_type_delete' form.instance.pk %}" class="btn btn-danger">
                    {% trans "Delete" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Color picker functionality
    $('.color-picker').on('click', function() {
        const color = $(this).data('color');
        $('#{{ form.color.id_for_label }}').val(color);
        updateColorPreview(color);
        updatePreview();
    });

    // Color input change
    $('#{{ form.color.id_for_label }}').on('input', function() {
        const color = $(this).val();
        updateColorPreview(color);
        updatePreview();
    });

    // Update color preview
    function updateColorPreview(color) {
        $('#colorPreview').css('background-color', color);
        $('#previewColor').css('background-color', color);
    }

    // Real-time preview updates
    $('#{{ form.name.id_for_label }}').on('input', function() {
        const name = $(this).val() || 'Expense Type Name';
        $('#previewName').text(name);
    });

    $('#{{ form.code.id_for_label }}').on('input', function() {
        const code = $(this).val() || 'CODE';
        $('#previewCode').text(code);
    });

    $('#{{ form.description.id_for_label }}').on('input', function() {
        const description = $(this).val() || 'Expense type description will appear here...';
        $('#previewDescription').text(description);
    });

    $('#{{ form.default_budget_limit.id_for_label }}').on('input', function() {
        const limit = $(this).val() || '0';
        $('#previewBudgetLimit').text('$' + limit);
    });

    $('#{{ form.max_amount_per_expense.id_for_label }}').on('input', function() {
        const maxAmount = $(this).val() || '0';
        $('#previewMaxAmount').text('$' + maxAmount);
    });

    $('#{{ form.is_active.id_for_label }}').on('change', function() {
        const isActive = $(this).is(':checked');
        const badge = $('#previewStatus');
        if (isActive) {
            badge.removeClass('bg-secondary').addClass('bg-success').text('{% trans "Active" %}');
        } else {
            badge.removeClass('bg-success').addClass('bg-secondary').text('{% trans "Inactive" %}');
        }
    });

    $('#{{ form.requires_approval.id_for_label }}').on('change', function() {
        const requiresApproval = $(this).is(':checked');
        if (requiresApproval) {
            $('#previewApproval').show();
        } else {
            $('#previewApproval').hide();
        }
    });

    // Form validation
    $('#expenseTypeForm').on('submit', function(e) {
        let isValid = true;
        
        // Check required fields
        const nameField = $('#{{ form.name.id_for_label }}');
        if (!nameField.val().trim()) {
            nameField.addClass('is-invalid');
            isValid = false;
        } else {
            nameField.removeClass('is-invalid');
        }

        // Validate color format
        const colorField = $('#{{ form.color.id_for_label }}');
        const colorValue = colorField.val();
        const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
        if (colorValue && !colorRegex.test(colorValue)) {
            colorField.addClass('is-invalid');
            isValid = false;
        } else {
            colorField.removeClass('is-invalid');
        }

        // Validate numeric fields
        const budgetLimitField = $('#{{ form.default_budget_limit.id_for_label }}');
        const maxAmountField = $('#{{ form.max_amount_per_expense.id_for_label }}');
        
        if (budgetLimitField.val() && isNaN(parseFloat(budgetLimitField.val()))) {
            budgetLimitField.addClass('is-invalid');
            isValid = false;
        } else {
            budgetLimitField.removeClass('is-invalid');
        }

        if (maxAmountField.val() && isNaN(parseFloat(maxAmountField.val()))) {
            maxAmountField.addClass('is-invalid');
            isValid = false;
        } else {
            maxAmountField.removeClass('is-invalid');
        }

        if (!isValid) {
            e.preventDefault();
            // Scroll to first error
            const firstError = $('.is-invalid').first();
            if (firstError.length) {
                $('html, body').animate({
                    scrollTop: firstError.offset().top - 100
                }, 500);
            }
        }
    });

    // Initialize preview
    function updatePreview() {
        // This function can be called to update the entire preview
        // Currently handled by individual field listeners
    }

    // Auto-generate code from name
    $('#{{ form.name.id_for_label }}').on('blur', function() {
        const codeField = $('#{{ form.code.id_for_label }}');
        if (!codeField.val()) {
            const name = $(this).val();
            const code = name.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10);
            codeField.val(code);
            $('#previewCode').text(code || 'CODE');
        }
    });
});
</script>
{% endblock %}