{% extends 'knowledge/base_knowledge.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Bulk Upload Documents" %} - {% trans "Knowledge Management" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">{% trans "Bulk Upload Documents" %}</h1>
                    <p class="text-muted">{% trans "Upload multiple documents at once to the knowledge base" %}</p>
                </div>
                <div>
                    <a href="{% url 'knowledge:document_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> {% trans "Back to Documents" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-upload"></i> {% trans "Upload Files" %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="bulkUploadForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="category" class="form-label">{% trans "Category" %} <span class="text-muted">({% trans "Optional" %})</span></label>
                            <select name="category" id="category" class="form-control">
                                <option value="">{% trans "Select a category" %}</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">{% trans "All uploaded documents will be assigned to this category" %}</small>
                        </div>

                        <div class="mb-4">
                            <label for="documents" class="form-label">{% trans "Select Files" %} <span class="text-danger">*</span></label>
                            <input type="file" name="documents" id="documents" class="form-control" multiple accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.xls,.xlsx" required>
                            <small class="form-text text-muted">
                                {% trans "Supported formats: PDF, DOC, DOCX, TXT, PPT, PPTX, XLS, XLSX" %}<br>
                                {% trans "Maximum file size: 10MB per file" %}
                            </small>
                        </div>

                        <div id="filePreview" class="mb-4" style="display: none;">
                            <h6>{% trans "Selected Files:" %}</h6>
                            <div id="fileList" class="list-group">
                                <!-- Files will be listed here -->
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFiles()">
                                <i class="fas fa-times"></i> {% trans "Clear All" %}
                            </button>
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="fas fa-upload"></i> {% trans "Upload Documents" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Upload Guidelines -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> {% trans "Upload Guidelines" %}
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>{% trans "All uploaded documents will be saved as 'Draft' status" %}</li>
                        <li>{% trans "Document titles will be automatically generated from file names" %}</li>
                        <li>{% trans "You can edit document details after upload" %}</li>
                        <li>{% trans "Large files may take longer to process" %}</li>
                        <li>{% trans "Ensure files are not corrupted before uploading" %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('documents');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const form = document.getElementById('bulkUploadForm');

    fileInput.addEventListener('change', function() {
        const files = this.files;
        if (files.length > 0) {
            displayFiles(files);
            filePreview.style.display = 'block';
        } else {
            filePreview.style.display = 'none';
        }
    });

    function displayFiles(files) {
        fileList.innerHTML = '';
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            
            const fileInfo = document.createElement('div');
            fileInfo.innerHTML = `
                <strong>${file.name}</strong><br>
                <small class="text-muted">${formatFileSize(file.size)} - ${file.type || 'Unknown type'}</small>
            `;
            
            const fileIcon = document.createElement('i');
            fileIcon.className = getFileIcon(file.name);
            
            fileItem.appendChild(fileIcon);
            fileItem.appendChild(fileInfo);
            fileList.appendChild(fileItem);
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        switch (ext) {
            case 'pdf': return 'fas fa-file-pdf text-danger';
            case 'doc':
            case 'docx': return 'fas fa-file-word text-primary';
            case 'xls':
            case 'xlsx': return 'fas fa-file-excel text-success';
            case 'ppt':
            case 'pptx': return 'fas fa-file-powerpoint text-warning';
            case 'txt': return 'fas fa-file-alt text-secondary';
            default: return 'fas fa-file text-muted';
        }
    }

    form.addEventListener('submit', function(e) {
        const files = fileInput.files;
        if (files.length === 0) {
            e.preventDefault();
            alert('{% trans "Please select at least one file to upload." %}');
            return;
        }

        // Show loading state
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Uploading..." %}';
        uploadBtn.disabled = true;
    });

    window.clearFiles = function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        fileList.innerHTML = '';
    };
});
</script>
{% endblock %}