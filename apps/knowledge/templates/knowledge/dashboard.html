{% extends 'knowledge/base_knowledge.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Knowledge Management Dashboard" %}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/knowledge.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">{% trans "Knowledge Management" %}</h1>
                    <p class="text-muted">{% trans "Manage and organize your organization's knowledge base" %}</p>
                </div>
                <div>
                    <a href="{% url 'knowledge:document_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> {% trans "Add Document" %}
                    </a>
                    <a href="{% url 'knowledge:bulk_upload' %}" class="btn btn-outline-primary">
                        <i class="fas fa-upload"></i> {% trans "Bulk Upload" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% trans "Total Documents" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-documents">
                                {{ stats.total_documents|default:0 }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans "Published Documents" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="published-documents">
                                {{ stats.published_documents|default:0 }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans "Categories" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-categories">
                                {{ stats.total_categories|default:0 }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-folder fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% trans "AI Processing Jobs" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="ai-jobs">
                                {{ stats.ai_jobs_pending|default:0 }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-robot fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Documents -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Recent Documents" %}</h6>
                    <a href="{% url 'knowledge:document_list' %}" class="btn btn-sm btn-outline-primary">
                        {% trans "View All" %}
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recent-documents-table">
                            <thead>
                                <tr>
                                    <th>{% trans "Title" %}</th>
                                    <th>{% trans "Category" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Created" %}</th>
                                    <th>{% trans "Views" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in recent_documents %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="mr-3">
                                                {% if document.file %}
                                                    <i class="fas fa-file-pdf text-danger"></i>
                                                {% else %}
                                                    <i class="fas fa-file-text text-primary"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <a href="{% url 'knowledge:document_detail' document.pk %}" class="font-weight-bold text-decoration-none">
                                                    {{ document.title|truncatechars:50 }}
                                                </a>
                                                <br>
                                                <small class="text-muted">{{ document.created_by.get_full_name }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if document.category %}
                                            <span class="badge badge-secondary" data-color="{{ document.category.color|default:'#6c757d' }}">
                                                {{ document.category.name }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">{% trans "Uncategorized" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-{% if document.status == 'approved' %}success{% elif document.status == 'review' %}warning{% elif document.status == 'draft' %}secondary{% else %}danger{% endif %}">
                                            {{ document.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ document.created_at|date:"M d, Y" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge badge-light">{{ document.view_count }}</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'knowledge:document_detail' document.pk %}" class="btn btn-outline-primary btn-sm" title="{% trans 'View' %}">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'knowledge:document_edit' document.pk %}" class="btn btn-outline-secondary btn-sm" title="{% trans 'Edit' %}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        {% trans "No documents found. Create your first document!" %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-xl-4 col-lg-5">
            <!-- Quick Search -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Quick Search" %}</h6>
                </div>
                <div class="card-body">
                    <form method="get" action="{% url 'knowledge:document_search' %}" id="quick-search-form">
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" placeholder="{% trans 'Search documents...' %}" id="quick-search-input">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="search-suggestions" class="mt-2" style="display: none;"></div>
                </div>
            </div>

            <!-- Popular Documents -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Popular Documents" %}</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for document in popular_documents %}
                        <div class="list-group-item list-group-item-action px-0">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <a href="{% url 'knowledge:document_detail' document.pk %}" class="text-decoration-none">
                                        {{ document.title|truncatechars:40 }}
                                    </a>
                                </h6>
                                <small class="text-muted">{{ document.view_count }} {% trans "views" %}</small>
                            </div>
                            <p class="mb-1 text-muted small">{{ document.content|truncatechars:80 }}</p>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            {% trans "No popular documents yet" %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Categories -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Categories" %}</h6>
                    <a href="{% url 'knowledge:category_list' %}" class="btn btn-sm btn-outline-primary">
                        {% trans "Manage" %}
                    </a>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for category in categories %}
                        <div class="list-group-item list-group-item-action px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge badge-pill" data-color="{{ category.color|default:'#007bff' }}">
                                    {% if category.icon %}<i class="{{ category.icon }}"></i>{% endif %}
                                    {{ category.name }}
                                </span>
                            </div>
                            <span class="badge badge-light">{{ category.documents.count }}</span>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            {% trans "No categories created yet" %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Document Types Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Document Types Distribution" %}</h6>
                </div>
                <div class="card-body">
                    <canvas id="documentTypesChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Activity Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Document Activity (Last 7 Days)" %}</h6>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Template variables for JavaScript
const URLS = {
    quickSearch: "{% url 'knowledge:document_search' %}",
    analytics: "{% url 'knowledge:dashboard' %}"
};

const CHART_DATA = {
    documentTypes: {
        labels: JSON.parse('{{ document_types_labels|default:"[]" }}'),
        data: JSON.parse('{{ document_types_data|default:"[]" }}')
    },
    activity: {
        labels: JSON.parse('{{ activity_labels|default:"[]" }}'),
        data: JSON.parse('{{ activity_data|default:"[]" }}')
    }
};

const TRANSLATIONS = {
    documentsCreated: '{% trans "Documents Created" %}'
};

// Apply dynamic colors
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-color]').forEach(function(element) {
        const color = element.getAttribute('data-color');
        element.style.backgroundColor = color;
        element.style.color = 'white';
    });
});

$(document).ready(function() {
    // Initialize charts
    initializeCharts();
    
    // Quick search with suggestions
    $('#quick-search-input').on('input', function() {
        const query = $(this).val();
        if (query.length >= 2) {
            $.ajax({
                url: URLS.quickSearch,
                data: { 'q': query },
                success: function(data) {
                    displaySearchSuggestions(data.suggestions);
                }
            });
        } else {
            $('#search-suggestions').hide();
        }
    });
    
    // Auto-refresh stats every 30 seconds
    setInterval(refreshStats, 30000);
});

function initializeCharts() {
    // Document Types Chart
    const docTypesCtx = document.getElementById('documentTypesChart');
    if (docTypesCtx) {
        new Chart(docTypesCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: CHART_DATA.documentTypes.labels,
                datasets: [{
                    data: CHART_DATA.documentTypes.data,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Activity Chart
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx) {
        new Chart(activityCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: CHART_DATA.activity.labels,
                datasets: [{
                    label: TRANSLATIONS.documentsCreated,
                    data: CHART_DATA.activity.data,
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

function displaySearchSuggestions(suggestions) {
    const container = $('#search-suggestions');
    if (suggestions.length > 0) {
        let html = '<div class="list-group">';
        suggestions.forEach(function(suggestion) {
            html += '<a href="' + suggestion.url + '" class="list-group-item list-group-item-action py-2">';
            html += '<div class="d-flex w-100 justify-content-between">';
            html += '<h6 class="mb-1 small">' + suggestion.title + '</h6>';
            html += '<small class="text-muted">' + suggestion.type + '</small>';
            html += '</div>';
            html += '</a>';
        });
        html += '</div>';
        container.html(html).show();
    } else {
        container.hide();
    }
}

function refreshStats() {
    $.ajax({
        url: URLS.analytics,
        data: { 'format': 'json' },
        success: function(data) {
            $('#total-documents').text(data.total_documents);
            $('#published-documents').text(data.published_documents);
            $('#total-categories').text(data.total_categories);
            $('#ai-jobs').text(data.ai_jobs_pending);
        }
    });
}
</script>
{% endblock %}