{% extends 'knowledge/base_knowledge.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Search Documents - Knowledge Base{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/knowledge.css' %}">
<style>
.search-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 0;
    margin-bottom: 2rem;
}

.search-box {
    background: white;
    border-radius: 50px;
    padding: 0.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.search-input {
    border: none;
    outline: none;
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
    width: 100%;
}

.search-btn {
    background: #667eea;
    border: none;
    border-radius: 50px;
    padding: 0.75rem 2rem;
    color: white;
    font-weight: 600;
}

.search-btn:hover {
    background: #5a6fd8;
    color: white;
}

.search-filters {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filter-section {
    margin-bottom: 1.5rem;
}

.filter-section:last-child {
    margin-bottom: 0;
}

.filter-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.search-results {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.search-result-item {
    padding: 1.5rem;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.3s ease;
}

.search-result-item:hover {
    background: #f8f9fa;
}

.search-result-item:last-child {
    border-bottom: none;
}

.result-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    text-decoration: none;
    margin-bottom: 0.5rem;
    display: block;
}

.result-title:hover {
    color: #667eea;
    text-decoration: none;
}

.result-snippet {
    color: #6c757d;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.result-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.result-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.search-highlight {
    background: #fff3cd;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-weight: 600;
}

.search-stats {
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    font-size: 0.9rem;
    color: #6c757d;
}

.no-results {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}

.no-results i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.search-suggestions {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 1rem;
    margin-top: 1rem;
}

.suggestion-item {
    display: inline-block;
    background: white;
    padding: 0.25rem 0.75rem;
    margin: 0.25rem;
    border-radius: 1rem;
    text-decoration: none;
    color: #495057;
    font-size: 0.875rem;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.suggestion-item:hover {
    background: #667eea;
    color: white;
    text-decoration: none;
    border-color: #667eea;
}

.advanced-search-toggle {
    background: none;
    border: none;
    color: white;
    text-decoration: underline;
    font-size: 0.9rem;
    opacity: 0.8;
}

.advanced-search-toggle:hover {
    opacity: 1;
    color: white;
}

.advanced-search-panel {
    display: none;
    background: rgba(255,255,255,0.1);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-top: 1rem;
}

.search-history {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.history-item {
    display: flex;
    align-items: center;
    justify-content: between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f8f9fa;
}

.history-item:last-child {
    border-bottom: none;
}

.history-query {
    flex: 1;
    color: #495057;
    text-decoration: none;
}

.history-query:hover {
    color: #667eea;
    text-decoration: none;
}

.history-time {
    font-size: 0.75rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .search-header {
        padding: 2rem 0;
    }
    
    .search-filters {
        padding: 1rem;
    }
    
    .result-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Search Header -->
<div class="search-header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-4">
                    <h1 class="display-4 mb-3">Search Knowledge Base</h1>
                    <p class="lead mb-0">Find documents, insights, and information across your organization</p>
                </div>
                
                <form method="get" id="search-form">
                    <div class="search-box">
                        <div class="d-flex">
                            <input type="text" 
                                   name="q" 
                                   value="{{ request.GET.q }}" 
                                   placeholder="Search documents, content, tags..."
                                   class="search-input"
                                   id="search-input"
                                   autocomplete="off">
                            <button type="submit" class="search-btn">
                                <i class="fas fa-search mr-2"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button type="button" class="advanced-search-toggle" id="advanced-toggle">
                            <i class="fas fa-cog mr-1"></i> Advanced Search
                        </button>
                    </div>
                    
                    <!-- Advanced Search Panel -->
                    <div class="advanced-search-panel" id="advanced-panel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-white-50">Category</label>
                                    <select name="category" class="form-control">
                                        <option value="">All Categories</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-white-50">Status</label>
                                    <select name="status" class="form-control">
                                        <option value="">All Status</option>
                                        <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>Published</option>
                                        <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
                                        <option value="archived" {% if request.GET.status == 'archived' %}selected{% endif %}>Archived</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-white-50">Date Range</label>
                                    <select name="date_range" class="form-control">
                                        <option value="">Any Time</option>
                                        <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
                                        <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
                                        <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
                                        <option value="year" {% if request.GET.date_range == 'year' %}selected{% endif %}>This Year</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-white-50">File Type</label>
                                    <select name="file_type" class="form-control">
                                        <option value="">All Types</option>
                                        <option value="pdf" {% if request.GET.file_type == 'pdf' %}selected{% endif %}>PDF</option>
                                        <option value="doc" {% if request.GET.file_type == 'doc' %}selected{% endif %}>Word Document</option>
                                        <option value="xls" {% if request.GET.file_type == 'xls' %}selected{% endif %}>Excel</option>
                                        <option value="txt" {% if request.GET.file_type == 'txt' %}selected{% endif %}>Text</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3">
            <!-- Quick Filters -->
            <div class="search-filters">
                <div class="filter-section">
                    <div class="filter-title">Quick Filters</div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recent" name="recent" {% if request.GET.recent %}checked{% endif %}>
                        <label class="form-check-label" for="recent">Recent Documents</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="featured" name="featured" {% if request.GET.featured %}checked{% endif %}>
                        <label class="form-check-label" for="featured">Featured</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="has_ai" name="has_ai" {% if request.GET.has_ai %}checked{% endif %}>
                        <label class="form-check-label" for="has_ai">AI Processed</label>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-title">Popular Tags</div>
                    {% for tag in popular_tags %}
                    <a href="?q={{ request.GET.q }}&tag={{ tag.name }}" class="suggestion-item">
                        {{ tag.name }} ({{ tag.document_count }})
                    </a>
                    {% endfor %}
                </div>
                
                <div class="filter-section">
                    <div class="filter-title">Categories</div>
                    {% for category in categories %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <a href="?q={{ request.GET.q }}&category={{ category.id }}" 
                           class="text-decoration-none {% if request.GET.category == category.id|stringformat:'s' %}font-weight-bold text-primary{% endif %}">
                            {{ category.name }}
                        </a>
                        <span class="badge badge-light">{{ category.document_count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Search History -->
            {% if search_history %}
            <div class="search-history">
                <h6 class="mb-3"><i class="fas fa-history mr-2"></i> Recent Searches</h6>
                {% for history in search_history %}
                <div class="history-item">
                    <a href="?q={{ history.query }}" class="history-query">
                        {{ history.query }}
                    </a>
                    <span class="history-time">{{ history.created_at|timesince }} ago</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Search Results -->
        <div class="col-lg-9">
            {% if request.GET.q %}
            <div class="search-results">
                {% if documents %}
                <div class="search-stats">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <strong>{{ documents|length }}</strong> results found for 
                            <strong>"{{ request.GET.q }}"</strong>
                            {% if search_time %}
                            in {{ search_time }}ms
                            {% endif %}
                        </span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                                <i class="fas fa-sort mr-1"></i> Sort by
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=relevance">Relevance</a>
                                <a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=date">Date</a>
                                <a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=title">Title</a>
                                <a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=views">Views</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% for document in documents %}
                <div class="search-result-item">
                    <a href="{% url 'knowledge:document_detail' document.id %}" class="result-title">
                        {% if document.highlighted_title %}
                            {{ document.highlighted_title|safe }}
                        {% else %}
                            {{ document.title }}
                        {% endif %}
                    </a>
                    
                    <div class="result-snippet">
                        {% if document.highlighted_content %}
                            {{ document.highlighted_content|safe|truncatewords:30 }}
                        {% else %}
                            {{ document.description|truncatewords:30|default:"No description available" }}
                        {% endif %}
                    </div>
                    
                    <div class="result-meta">
                        <div class="result-meta-item">
                            <i class="fas fa-folder text-muted"></i>
                            <span>{{ document.category.name }}</span>
                        </div>
                        <div class="result-meta-item">
                            <i class="fas fa-user text-muted"></i>
                            <span>{{ document.created_by.get_full_name|default:document.created_by.username }}</span>
                        </div>
                        <div class="result-meta-item">
                            <i class="fas fa-calendar text-muted"></i>
                            <span>{{ document.updated_at|date:"M d, Y" }}</span>
                        </div>
                        <div class="result-meta-item">
                            <i class="fas fa-eye text-muted"></i>
                            <span>{{ document.view_count }} views</span>
                        </div>
                        {% if document.file %}
                        <div class="result-meta-item">
                            <i class="fas fa-file text-muted"></i>
                            <span>{{ document.file_type|upper }}</span>
                        </div>
                        {% endif %}
                        {% if document.description %}
                        <div class="result-meta-item">
                            <i class="fas fa-info-circle text-info"></i>
                            <span>Has Description</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if document.tags.all %}
                    <div class="mt-2">
                        {% for tag in document.tags.all %}
                        <a href="?q={{ request.GET.q }}&tag={{ tag.name }}" class="badge badge-secondary mr-1">
                            {{ tag.name }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if is_paginated %}
                <div class="d-flex justify-content-center p-3">
                    <nav>
                        <ul class="pagination">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.GET.urlencode }}&page=1">&laquo; First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">Previous</a>
                            </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
                
                {% else %}
                <!-- No Results -->
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h4>No documents found</h4>
                    <p>We couldn't find any documents matching your search criteria.</p>
                    
                    <div class="search-suggestions">
                        <h6><i class="fas fa-lightbulb mr-2"></i> Suggestions:</h6>
                        <ul class="list-unstyled mb-0">
                            <li>• Try different keywords or phrases</li>
                            <li>• Check your spelling</li>
                            <li>• Use broader search terms</li>
                            <li>• Remove filters to expand results</li>
                        </ul>
                        
                        {% if suggested_queries %}
                        <div class="mt-3">
                            <strong>Try these searches:</strong><br>
                            {% for suggestion in suggested_queries %}
                            <a href="?q={{ suggestion }}" class="suggestion-item">{{ suggestion }}</a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Welcome State -->
            <div class="text-center py-5">
                <i class="fas fa-search fa-4x text-muted mb-4"></i>
                <h3>Start your search</h3>
                <p class="text-muted mb-4">Enter keywords above to find documents, insights, and information.</p>
                
                {% if popular_searches %}
                <div class="mb-4">
                    <h6>Popular searches:</h6>
                    {% for search in popular_searches %}
                    <a href="?q={{ search.query }}" class="suggestion-item">{{ search.query }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-tips mr-2"></i> Search Tips</h6>
                                <ul class="list-unstyled text-left mb-0">
                                    <li class="mb-2">• Use quotes for exact phrases: <code>"project management"</code></li>
                                    <li class="mb-2">• Use AND/OR for multiple terms: <code>budget AND planning</code></li>
                                    <li class="mb-2">• Use wildcards: <code>manage*</code> finds manage, manager, management</li>
                                    <li class="mb-2">• Search by file type: <code>filetype:pdf budget</code></li>
                                    <li>• Search by author: <code>author:john budget</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Search Suggestions Dropdown -->
<div id="search-suggestions" class="position-absolute bg-white border rounded shadow-sm" style="display: none; z-index: 1000;"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/knowledge.js' %}"></script>
<script>
let searchTimeout;
let currentSuggestionIndex = -1;

$(document).ready(function() {
    initializeSearch();
    bindFilterEvents();
});

function initializeSearch() {
    const searchInput = $('#search-input');
    const suggestionsContainer = $('#search-suggestions');
    
    // Auto-complete suggestions
    searchInput.on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                fetchSearchSuggestions(query);
            }, 300);
        } else {
            suggestionsContainer.hide();
        }
    });
    
    // Keyboard navigation
    searchInput.on('keydown', function(e) {
        const suggestions = suggestionsContainer.find('.suggestion-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, suggestions.length - 1);
            updateSuggestionHighlight(suggestions);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, -1);
            updateSuggestionHighlight(suggestions);
        } else if (e.key === 'Enter' && currentSuggestionIndex >= 0) {
            e.preventDefault();
            const selectedSuggestion = suggestions.eq(currentSuggestionIndex);
            searchInput.val(selectedSuggestion.text());
            suggestionsContainer.hide();
            $('#search-form').submit();
        } else if (e.key === 'Escape') {
            suggestionsContainer.hide();
            currentSuggestionIndex = -1;
        }
    });
    
    // Advanced search toggle
    $('#advanced-toggle').on('click', function() {
        $('#advanced-panel').slideToggle();
        const icon = $(this).find('i');
        icon.toggleClass('fa-cog fa-times');
    });
    
    // Position suggestions
    searchInput.on('focus', function() {
        positionSuggestions();
    });
    
    // Hide suggestions when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#search-input, #search-suggestions').length) {
            suggestionsContainer.hide();
        }
    });
}

function fetchSearchSuggestions(query) {
    $.ajax({
        url: '/knowledge/ajax/search-suggestions/',
        method: 'GET',
        data: { q: query },
        success: function(data) {
            displaySearchSuggestions(data.suggestions);
        },
        error: function() {
            $('#search-suggestions').hide();
        }
    });
}

function displaySearchSuggestions(suggestions) {
    const container = $('#search-suggestions');
    container.empty();
    
    if (suggestions.length === 0) {
        container.hide();
        return;
    }
    
    suggestions.forEach((suggestion, index) => {
        const item = $(`
            <div class="suggestion-item p-2 border-bottom cursor-pointer" data-index="${index}">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${suggestion.text}</span>
                    <small class="text-muted">${suggestion.count} results</small>
                </div>
            </div>
        `);
        
        item.on('click', function() {
            $('#search-input').val(suggestion.text);
            container.hide();
            $('#search-form').submit();
        });
        
        item.on('mouseenter', function() {
            currentSuggestionIndex = index;
            updateSuggestionHighlight(container.find('.suggestion-item'));
        });
        
        container.append(item);
    });
    
    positionSuggestions();
    container.show();
    currentSuggestionIndex = -1;
}

function updateSuggestionHighlight(suggestions) {
    suggestions.removeClass('bg-light');
    if (currentSuggestionIndex >= 0) {
        suggestions.eq(currentSuggestionIndex).addClass('bg-light');
    }
}

function positionSuggestions() {
    const searchInput = $('#search-input');
    const container = $('#search-suggestions');
    const inputOffset = searchInput.offset();
    
    container.css({
        top: inputOffset.top + searchInput.outerHeight(),
        left: inputOffset.left,
        width: searchInput.outerWidth(),
        maxHeight: '300px',
        overflowY: 'auto'
    });
}

function bindFilterEvents() {
    // Quick filters
    $('.form-check-input').on('change', function() {
        updateSearchWithFilters();
    });
    
    // Advanced search form changes
    $('#advanced-panel select').on('change', function() {
        updateSearchWithFilters();
    });
}

function updateSearchWithFilters() {
    const form = $('#search-form');
    const formData = new FormData(form[0]);
    const params = new URLSearchParams();
    
    // Add form data to params
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Add checkbox filters
    $('.form-check-input:checked').each(function() {
        params.append($(this).attr('name'), 'on');
    });
    
    // Update URL
    const newUrl = window.location.pathname + '?' + params.toString();
    window.location.href = newUrl;
}

// Track search analytics
if (typeof KnowledgeSystem !== 'undefined') {
    const query = new URLSearchParams(window.location.search).get('q');
    if (query) {
        KnowledgeSystem.trackSearch(query);
    }
}

// Auto-focus search input
$('#search-input').focus();
</script>
{% endblock %}