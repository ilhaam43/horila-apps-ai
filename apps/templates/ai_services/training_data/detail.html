{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ training_data.title }} - Training Data Detail{% endblock %}

{% block extra_css %}
<link href="{% static 'css/training-data.css' %}" rel="stylesheet">
<style>
.detail-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.detail-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
}

.status-badge {
    font-size: 0.9rem;
    padding: 8px 16px;
}

.info-item {
    border-bottom: 1px solid #f1f3f4;
    padding: 15px 0;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
}

.info-value {
    color: #6c757d;
}

.file-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-top: 10px;
}

.processing-log {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-top: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    max-height: 300px;
    overflow-y: auto;
}

.tag-item {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    margin: 2px;
}

.metadata-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.metadata-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
}

.action-timeline {
    position: relative;
    padding-left: 30px;
}

.action-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #007bff;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'ai_services:training_data_dashboard' %}">Training Data</a></li>
                            <li class="breadcrumb-item active">{{ training_data.title|truncatechars:30 }}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    {% if can_edit %}
                        <a href="{% url 'ai_services:training_data_edit' training_data.id %}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                    {% endif %}
                    {% if training_data.processing_status == 'pending' or training_data.processing_status == 'failed' %}
                        <button class="btn btn-success me-2" data-training-id="{{ training_data.id }}" onclick="processTrainingData(this.dataset.trainingId)">
                            <i class="fas fa-play me-1"></i>Process
                        </button>
                    {% endif %}
                    {% if can_delete %}
                        <button class="btn btn-outline-danger me-2" data-training-id="{{ training_data.id }}" data-training-title="{{ training_data.title|escapejs }}" onclick="deleteTrainingData(this.dataset.trainingId, this.dataset.trainingTitle)">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    {% endif %}
                    <a href="{% url 'ai_services:training_data_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Main Information -->
            <div class="detail-card">
                <div class="detail-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="mb-2">{{ training_data.title }}</h3>
                            <p class="mb-0 opacity-75">{{ training_data.description }}</p>
                        </div>
                        <div class="text-end">
                            {% if training_data.processing_status == 'pending' %}
                                <span class="badge bg-warning status-badge">{{ training_data.get_processing_status_display }}</span>
                            {% elif training_data.processing_status == 'processing' %}
                                <span class="badge bg-primary status-badge">{{ training_data.get_processing_status_display }}</span>
                            {% elif training_data.processing_status == 'completed' %}
                                <span class="badge bg-success status-badge">{{ training_data.get_processing_status_display }}</span>
                            {% elif training_data.processing_status == 'failed' %}
                                <span class="badge bg-danger status-badge">{{ training_data.get_processing_status_display }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Tipe Data</div>
                                <div class="info-value">
                                    <span class="badge bg-info">{{ training_data.get_data_type_display }}</span>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">Target Service</div>
                                <div class="info-value">
                                    <span class="badge bg-secondary">{{ training_data.get_target_service_display }}</span>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">Uploaded By</div>
                                <div class="info-value">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-circle fa-lg me-2 text-muted"></i>
                                        <div>
                                            <div>{{ training_data.uploaded_by.get_full_name|default:training_data.uploaded_by.username }}</div>
                                            <small class="text-muted">{{ training_data.uploaded_by.email }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Created</div>
                                <div class="info-value">
                                    <i class="fas fa-calendar me-2 text-muted"></i>
                                    {{ training_data.created_at|date:"d M Y, H:i" }}
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">Last Updated</div>
                                <div class="info-value">
                                    <i class="fas fa-clock me-2 text-muted"></i>
                                    {{ training_data.updated_at|date:"d M Y, H:i" }}
                                </div>
                            </div>
                            
                            {% if training_data.processed_by %}
                            <div class="info-item">
                                <div class="info-label">Processed By</div>
                                <div class="info-value">
                                    <i class="fas fa-user-cog me-2 text-muted"></i>
                                    {{ training_data.processed_by.get_full_name|default:training_data.processed_by.username }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if training_data.tags %}
                    <div class="info-item">
                        <div class="info-label">Tags</div>
                        <div class="info-value">
                            {% for tag in training_data.tags_list %}
                                <span class="tag-item">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if training_data.notes %}
                    <div class="info-item">
                        <div class="info-label">Notes</div>
                        <div class="info-value">{{ training_data.notes|linebreaks }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- File Information -->
            {% if training_data.file %}
            <div class="detail-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-file me-2"></i>File Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-file-alt fa-2x text-primary me-3"></i>
                                <div>
                                    <div class="fw-bold">{{ training_data.file_name }}</div>
                                    <div class="text-muted small">{{ training_data.file_type|upper }} File</div>
                                </div>
                            </div>
                            
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="fw-bold text-primary">{{ training_data.file_size|filesizeformat }}</div>
                                    <div class="small text-muted">File Size</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="fw-bold text-success">{{ training_data.file_type|upper }}</div>
                                    <div class="small text-muted">Format</div>
                                </div>
                                {% if training_data.file_metadata %}
                                {% if training_data.file_metadata.pages %}
                                <div class="metadata-item">
                                    <div class="fw-bold text-info">{{ training_data.file_metadata.pages }}</div>
                                    <div class="small text-muted">Pages</div>
                                </div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{% url 'ai_services:training_data_download' training_data.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-download me-2"></i>Download File
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Processing Results -->
            {% if training_data.processing_results or training_data.processing_status == 'completed' %}
            <div class="detail-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Processing Results</h5>
                </div>
                <div class="card-body">
                    {% if training_data.processing_results %}
                        <div class="processing-log">
                            {{ training_data.processing_results|linebreaks }}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h6 class="text-success">Processing Completed Successfully</h6>
                            <p class="text-muted">Training data has been processed and integrated into the AI system.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if training_data.processing_status == 'pending' or training_data.processing_status == 'failed' %}
                            <button class="btn btn-success" data-training-id="{{ training_data.id }}" onclick="processTrainingData(this.dataset.trainingId)">
                                <i class="fas fa-play me-2"></i>Start Processing
                            </button>
                        {% endif %}
                        
                        {% if training_data.file %}
                            <a href="{% url 'ai_services:training_data_download' training_data.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-download me-2"></i>Download File
                            </a>
                        {% endif %}
                        
                        {% if can_edit %}
                            <a href="{% url 'ai_services:training_data_edit' training_data.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-edit me-2"></i>Edit Details
                            </a>
                        {% endif %}
                        
                        <button class="btn btn-outline-info" onclick="duplicateTrainingData()">
                            <i class="fas fa-copy me-2"></i>Duplicate
                        </button>
                        
                        <button class="btn btn-outline-warning" onclick="exportTrainingData()">
                            <i class="fas fa-file-export me-2"></i>Export Metadata
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Processing Status -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Processing Status</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if training_data.processing_status == 'pending' %}
                            <i class="fas fa-clock fa-3x text-warning mb-2"></i>
                            <h6 class="text-warning">Pending</h6>
                            <p class="small text-muted">Waiting to be processed</p>
                        {% elif training_data.processing_status == 'processing' %}
                            <i class="fas fa-cog fa-spin fa-3x text-primary mb-2"></i>
                            <h6 class="text-primary">Processing</h6>
                            <p class="small text-muted">Currently being processed</p>
                        {% elif training_data.processing_status == 'completed' %}
                            <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                            <h6 class="text-success">Completed</h6>
                            <p class="small text-muted">Successfully processed</p>
                        {% elif training_data.processing_status == 'failed' %}
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-2"></i>
                            <h6 class="text-danger">Failed</h6>
                            <p class="small text-muted">Processing failed</p>
                        {% endif %}
                    </div>
                    
                    {% if training_data.processing_status == 'processing' %}
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 75%"></div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">Processing in progress...</small>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Activity Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Activity Timeline</h6>
                </div>
                <div class="card-body">
                    <div class="action-timeline">
                        <div class="timeline-item">
                            <div class="fw-bold">Created</div>
                            <div class="small text-muted">{{ training_data.created_at|date:"d M Y, H:i" }}</div>
                            <div class="small">by {{ training_data.uploaded_by.get_full_name|default:training_data.uploaded_by.username }}</div>
                        </div>
                        
                        {% if training_data.updated_at != training_data.created_at %}
                        <div class="timeline-item">
                            <div class="fw-bold">Updated</div>
                            <div class="small text-muted">{{ training_data.updated_at|date:"d M Y, H:i" }}</div>
                        </div>
                        {% endif %}
                        
                        {% if training_data.processed_by %}
                        <div class="timeline-item">
                            <div class="fw-bold">Processed</div>
                            <div class="small text-muted">{{ training_data.updated_at|date:"d M Y, H:i" }}</div>
                            <div class="small">by {{ training_data.processed_by.get_full_name|default:training_data.processed_by.username }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konfirmasi Hapus</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Apakah Anda yakin ingin menghapus training data <strong id="deleteItemName"></strong>?</p>
                <p class="text-muted small">Tindakan ini tidak dapat dibatalkan.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Hapus</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Process training data
function processTrainingData(id) {
    if (confirm('Mulai proses training data ini?')) {
        fetch('/ai-services/training-data/' + id + '/process/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat memproses data.');
        });
    }
}

// Delete training data
function deleteTrainingData(id, title) {
    document.getElementById('deleteItemName').textContent = title;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
    
    document.getElementById('confirmDelete').addEventListener('click', function() {
        fetch('/ai-services/training-data/' + id + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "ai_services:training_data_dashboard" %}';
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat menghapus data.');
        });
        
        modal.hide();
    });
}

// Duplicate training data
function duplicateTrainingData() {
    if (confirm('Buat duplikat dari training data ini?')) {
        // TODO: Implement duplicate functionality
        alert('Duplicate functionality will be implemented.');
    }
}

// Export training data metadata
function exportTrainingData() {
    // TODO: Implement export functionality
    alert('Export functionality will be implemented.');
}

// Auto-refresh for processing status
if (document.querySelector('.status-badge') && document.querySelector('.status-badge').textContent.includes('Processing')) {
    setInterval(function() {
        fetch(window.location.href, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Check if status has changed
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newStatus = doc.querySelector('.status-badge');
            const currentStatus = document.querySelector('.status-badge');
            
            if (newStatus && currentStatus && newStatus.textContent !== currentStatus.textContent) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
        });
    }, 5000); // Check every 5 seconds
}
</script>
{% endblock %}